# 03. Functional Requirements（機能要件）

本章では、模写評価AIアプリ（Drawing Evaluation App）の機能要件を定義する。  
ユーザーがスマートフォンアプリ（React Native）を通じて行う操作、および  
バックエンド（FastAPI + PyTorch + DeepSeek API）が提供する機能を対象とする。

---

## 3.1 前提・用語

- **お題（Challenge）**  
  運営側が用意し、ユーザーに模写させる課題画像。  
  難易度・カテゴリなどのメタ情報を持つ。

- **模写投稿（Submission）**  
  ユーザーがあるお題に対して提出する模写画像。

- **定量評価（Quantitative Evaluation）**  
  PyTorch ベースの画像モデルにより算出される数値評価。  
  類似度スコア、サブスコア（構図・線精度 等）、ヒートマップを含む。

- **定性的評価（Qualitative Evaluation）**  
  DeepSeek LLM API によって生成される、文章による講評・改善アドバイス。

- **ユーザー（User）**  
  本アプリにログインして利用する個人。匿名利用は原則想定しない。

---

## 3.2 機能一覧

主要な機能を以下に一覧する。

| ID | カテゴリ | 機能名 | 概要 | 優先度 |
|----|----------|--------|------|--------|
| FR-001 | ユーザー管理 | ユーザー登録・ログイン | Google / Email で認証し、ユーザーを識別する | ★★★ |
| FR-002 | ユーザー管理 | プロフィール閲覧 | 自分の基本情報・簡易統計を表示する | ★★☆ |
| FR-010 | お題管理 | お題一覧表示 | 登録済みお題をリスト表示する | ★★★ |
| FR-011 | お題管理 | お題詳細表示 | お題画像・説明・難易度などを表示する | ★★★ |
| FR-012 | お題管理 | お題の難易度・カテゴリフィルタ | 難易度やジャンルでお題を絞り込む | ★★☆ |
| FR-020 | 模写投稿 | 模写画像の撮影・選択 | カメラorギャラリーから模写画像を取得する | ★★★ |
| FR-021 | 模写投稿 | 模写画像のアップロード | お題に紐づけてサーバーへ画像を送信する | ★★★ |
| FR-030 | 定量評価 | 類似度スコア算出 | お題画像との類似度スコア（0〜100）を計算する | ★★★ |
| FR-031 | 定量評価 | サブスコア算出 | 構図・線精度などのサブスコアを算出する | ★★☆ |
| FR-032 | 定量評価 | 差分ヒートマップ生成 | お題と模写の差分ヒートマップを生成する | ★★☆ |
| FR-040 | 定性的評価 | 講評生成（DeepSeek） | 定量評価結果を基に LLM で講評を生成する | ★★★ |
| FR-041 | 定性的評価 | 講評表示 | 講評テキストをアプリ上で表示する | ★★★ |
| FR-050 | 結果表示 | 評価結果統合表示 | スコア・ヒートマップ・講評をまとめて表示する | ★★★ |
| FR-051 | 結果表示 | 再挑戦導線 | 同じお題・別のお題への再挑戦ボタンを提供する | ★★☆ |
| FR-060 | 履歴管理 | 評価履歴保存 | 各投稿の結果をユーザーごとに保存する | ★★★ |
| FR-061 | 履歴管理 | 履歴一覧表示 | 過去の評価履歴一覧を表示する | ★★☆ |
| FR-062 | 履歴管理 | 履歴詳細表示 | 特定の評価結果詳細（スコア・講評等）を表示する | ★★☆ |
| FR-070 | 共有 | 評価結果の共有 | スコアや講評を SNS 等に共有できるようにする | ★☆☆ |
| FR-080 | 管理者向け | お題登録・編集 | 管理者が新規お題を登録・編集する | ★★☆ |
| FR-081 | 管理者向け | 不適切投稿の閲覧・対処 | 不適切な模写投稿を確認・対応する | ★★☆ |

※優先度：★☆☆（低）〜★★★（高）

---

## 3.3 ユーザー管理

### FR-001 ユーザー登録・ログイン

**目的**  
ユーザーを一意に識別し、評価履歴・設定などをユーザー単位で管理する。

**前提条件**

- アプリが起動可能であり、ネットワーク接続があること。
- バックエンドに認証機構（例：Firebase Auth / Supabase Auth 等）が接続されていること。

**基本フロー（Googleログインの場合）**

1. ユーザーは「ログイン」画面で「Googleでログイン」ボタンをタップする。
2. OS標準の認証フローまたはWebViewでGoogle認証画面が表示される。
3. ユーザーが認証を完了すると、アプリは認証トークンを取得する。
4. アプリは認証トークンをバックエンド API に送信する。
5. バックエンドはトークンを検証し、ユーザー情報を作成 or 取得する。
6. バックエンドはアプリに対してアクセストークン（JWT等）とユーザーIDを返す。
7. アプリはトークンを安全なストレージに保存し、以後のAPIリクエストに付与する。

**入力**

- Google の認証情報（アクセストークン）
- または Email / パスワード（一旦MVPではGoogle優先でもよい）

**出力**

- アクセストークン
- ユーザーID
- 表示名、アイコンURL（あれば）

**エラー・例外**

- 認証失敗時はユーザーに簡潔なエラーメッセージを表示し、再試行を促す。
- ネットワークエラー時にはリトライボタンを表示する。

---

### FR-002 プロフィール閲覧

**目的**  
ユーザーが自分の基本情報と、簡単な統計情報を確認できるようにする。

**内容**

- 表示項目例：
  - 表示名
  - 総投稿回数
  - 平均スコア
  - 最近挑戦したお題 3 件
- 編集機能は初期リリースでは必須ではない（ニックネーム変更などは後続検討）。

---

## 3.4 お題管理（Challenge Management）

### FR-010 お題一覧表示

**目的**  
ユーザーが挑戦可能なお題を一覧から選択できるようにする。

**前提条件**

- バックエンドにお題データが登録されていること。

**基本フロー**

1. アプリ起動後、ホーム画面または「お題」タブでお題一覧を取得する。
2. アプリは `/challenges` API を呼び出す。
3. バックエンドはお題のリスト（ID、サムネイルURL、タイトル、難易度 等）を返す。
4. アプリはカード形式またはリスト形式でお題を表示する。

**入力**

- ページ番号、ソート条件（任意）
- フィルタ条件（FR-012と連携）

**出力**

- お題ID
- タイトル
- 難易度（例：初級/中級/上級）
- カテゴリ（人物/静物/背景など）
- サムネイル画像URL

---

### FR-011 お題詳細表示

**目的**  
ユーザーが挑戦前に、お題の内容・難易度・説明を確認できるようにする。

**基本フロー**

1. ユーザーが一覧から任意のお題をタップする。
2. アプリは `/challenges/{challenge_id}` API を呼び出す。
3. バックエンドはお題の詳細情報を返す。
4. アプリは以下を表示する：
   - お題画像（基準画像）
   - タイトル
   - 説明
   - 難易度
   - カテゴリ
   - 想定練習目的（例：線の安定、顔のバランス 等）
   - 「このお題に挑戦する」ボタン

**出力例**

- challenge_id
- title
- description
- difficulty
- category
- reference_image_url
- tips（任意の補足メモ）

---

### FR-012 お題の難易度・カテゴリフィルタ

**目的**  
ユーザーが自分のレベルや興味に合ったお題を探しやすくする。

**機能内容**

- 絞り込み条件：
  - 難易度（初級/中級/上級）
  - カテゴリ（人物/背景/静物/その他）
- UI：
  - タブ or ドロップダウン or チップボタン
- バックエンド：
  - `/challenges?difficulty=beginner&category=portrait` のようなクエリパラメータを想定。

---

## 3.5 模写投稿（Submission）

### FR-020 模写画像の撮影・選択

**目的**  
ユーザーが自分の模写をスマホから簡単に提出できるようにする。

**機能内容**

- お題詳細画面に「模写を投稿する」ボタンを設置。
- 選択肢：
  - カメラで撮影
  - 端末内ギャラリーから選択
- 画像は縦横比・最大サイズなどを一定範囲に収めるため、フロント側でリサイズする（例：長辺 1024px 程度）。

---

### FR-021 模写画像のアップロード

**目的**  
選択された模写画像を、指定のお題に紐づけてサーバーに送信する。

**基本フロー**

1. ユーザーがお題詳細画面から画像を選択する。
2. アプリは `/challenges/{challenge_id}/submissions` に対して画像を multipart/form-data で送信する。
3. バックエンドは画像を受け取り、一時的なストレージに保存する。
4. バックエンドは Submission ID を発行し、評価処理（定量評価・定性評価）をキックする。
5. アプリには Submission ID または「評価処理中」のステータスが返る。

**入力**

- challenge_id
- 画像ファイル（模写画像）
- ユーザーID（認証トークンから取得）

**出力**

- submission_id
- status（例：`processing`）

---

## 3.6 定量評価（Quantitative Evaluation）

### FR-030 類似度スコア算出

**目的**  
お題画像との類似度を 0〜100 点で算出し、ユーザーに数値として提示する。

**処理内容（サーバー側）**

1. お題画像の特徴量は事前に計算し、DB かストレージに保存しておく。
2. Submission に紐づく模写画像から特徴量を抽出する。
3. Cosine Similarity 等でお題画像との類似度を計算する。
4. 類似度を 0〜100 のスコアに正規化する（変換関数は評価ロジックで定義）。

**出力（API側）**

- overall_score（0〜100）
- 類似度の生値および必要に応じて補助情報（任意）。

---

### FR-031 サブスコア算出

**目的**  
ユーザーに対して「何がどの程度できているか」を分かりやすくするため、  
複数の観点（サブスコア）で評価する。

**想定サブスコア項目（一例）**

- composition_score（構図の一致度）
- line_accuracy_score（線の精度）
- proportion_score（パーツの比率）
- detail_score（細部の再現度） ※MVPでは後回しでもよい

**出力**

- scores:
  - composition: 0〜100
  - line_accuracy: 0〜100
  - proportion: 0〜100
  - （将来拡張可能な形で）

---

### FR-032 差分ヒートマップ生成

**目的**  
お題画像と模写画像の差分を視覚的に提示し、ユーザーが「どこがズレているのか」を直感的に理解できるようにする。

**処理内容**

- お題画像と模写画像を位置合わせ・スケーリングしたうえで差分を計算する。
- 差分値をヒートマップとして可視化し、お題画像に重ね合わせた画像を生成する。
- 生成画像を一時ストレージに保存し、URLを結果として返す。

**出力**

- heatmap_image_url（ユーザーが閲覧できるURL）

---

## 3.7 定性的評価（DeepSeekによる講評）

### FR-040 講評生成（DeepSeek）

**目的**  
定量評価の結果をもとに、ユーザーにとって分かりやすい文章で講評・改善アドバイスを提示する。

**処理内容（サーバー側）**

1. 定量評価結果（overall_score / サブスコア / お題情報 等）をまとめる。
2. 必要に応じて「誤差の概要」をテキスト化する（例：上部パーツのズレが大きい 等）。
3. 上記情報を DeepSeek API にプロンプトとして渡す。
4. DeepSeek から返却されたテキストを講評として Submission に保存する。

**出力例（論理構造）**

- `summary`：総評（1〜2文）
- `strengths`：良い点のリスト
- `weaknesses`：改善点のリスト
- `suggestions`：次の練習への提案

※実装上は一つのテキストフィールドとして保存してもよい。

**エラーハンドリング**

- DeepSeek API が失敗した場合、簡易なテンプレートメッセージを返す：
  - 例：「今回は数値スコアのみの表示になります。しばらくしてから再度お試しください。」

---

### FR-041 講評表示

**目的**  
ユーザーが講評を読みやすい形で確認できるようにする。

**UI要件（例）**

- 総評を最上部に表示（1〜2行）
- 良い点 / 改善点 / アドバイスをセクションで分ける（見出し付き）
- 講評はスクロール可能なテキスト領域で表示

---

## 3.8 結果表示（Result View）

### FR-050 評価結果統合表示

**目的**  
ユーザーが「自分の模写の評価」を一画面で把握できるようにする。

**表示内容**

- お題画像（サムネイル or 小さめ）
- ユーザーの模写画像
- スコア（overall_score）
- サブスコア一覧
- ヒートマップ画像
- 講評テキスト

**その他**

- 読み込み中はローディングインジケータを表示。
- 評価処理に数秒かかる前提で、ユーザーに待ち時間の目安を示す。

---

### FR-051 再挑戦導線

**目的**  
ユーザーが継続的に練習しやすい導線を提供する。

**機能内容**

- 結果画面に「同じお題で再挑戦」ボタン
- 「他のお題に挑戦する」ボタン（お題一覧へ戻る）

---

## 3.9 履歴管理（History）

### FR-060 評価履歴保存

**目的**  
ユーザーごとの成長を可視化できるように、各 Submission の結果を保存する。

**保存内容の例**

- submission_id
- user_id
- challenge_id
- overall_score
- サブスコア
- 講評テキスト
- 作成日時
- 参考画像URL / ヒートマップURL

---

### FR-061 履歴一覧表示

**目的**  
ユーザーが過去の模写とスコアを一覧で確認できるようにする。

**表示内容**

- お題タイトル
- スコア
- 日付
- 簡易タグ（例：初級/中級、人物/背景 等）

---

### FR-062 履歴詳細表示

**目的**  
過去の特定の投稿の詳細（当時のスコア・講評・ヒートマップ）を再確認できるようにする。

**内容**

- 当時の結果画面（FR-050 とほぼ同じ構成）
- 将来的には、同じお題での過去スコア推移グラフを表示する可能性あり。

---

## 3.10 共有機能（Optional）

### FR-070 評価結果の共有

**目的**  
ユーザーが自分の成果をSNS等に共有し、モチベーションを高める。

**機能候補**

- スコアとお題名、日付などを含むシェア用画像の生成
- シェアボタン（X 等）からの外部アプリ連携

※初期はテキストシェアのみ、画像生成は将来拡張でもよい。

---

## 3.11 管理者向け機能（Admin）

### FR-080 お題登録・編集

**目的**  
運営側が新しいお題を追加したり、既存のお題を編集できるようにする。

**内容（管理用UI or バックエンドツール）**

- お題画像のアップロード
- タイトル・説明文・難易度・カテゴリの設定
- モデル用特徴量の事前計算トリガー（バッチ or API）

---

### FR-081 不適切投稿の閲覧・対処

**目的**  
公序良俗に反する投稿があった場合に、運営側で確認・対処できるようにする。

**内容（初期は簡易でよい）**

- 通報された投稿の一覧表示
- 対象投稿の非表示・削除フラグの付与

---

## 3.12 今後の拡張に向けた機能候補（参考）

本章では、初期リリース後に検討し得る機能の例を示す（詳細は別途）。

- ユーザーが任意の画像を“お題”として登録できるカスタムモード
- AIによる「お手本自動生成」機能
- コミュニティ機能（ランキング・コメント・フォロー等）
- 学習プラン自動生成（ユーザーの弱点に合わせたお題推薦）


